/*
* VARS
 */
$shareinput = $('#share-input');
var imgsToPost = [];
var formData = new FormData();


//share function imgs
function sharePostImgs(formData, event) {
    $.ajax({
        method: 'POST',
        url: "inc/Share/shareimgs.php",
        data: formData,
        processData: false,
        contentType: false
    }).done(function(msg){
        //rend activable le bt-send
        $('#share-post').parent().removeClass('active-mask');
        //methode utilisé car impossible de recuperer les valeurs en cas de retour JSON
        var pieces = msg.split('-');
        if(pieces.length < 3)
        {
            //IMG VALID
            var imgName = pieces[1];
            //important pour la fonction de delete
            var containerName = "cont-" + imgName;
            var apercu_src = URL.createObjectURL(event.target.files[0]);
            var html = "<div class='img-share-container' id='"+ containerName +"' onClick='deletePhoto($(this))'><div class='img-container col-md-12'><img src='"+ apercu_src +"'><div class='delete-img-post'></div></div></div>";
            $('.img-share-bloc').append(html);
        }
        if(pieces.length >= 3)
        {
            //IMG INVALID
            //suppression de l'image du tableau d'images
            var removeItem = pieces[1];
            imgsToPost = $.grep(imgsToPost, function(value) {
                return value != removeItem;
            });
            //display du message d'erreur
            var locationError = ".img-share-input";
            var classBulleSpecial;
            var errorMsg = pieces[3];
            if(errorMsg == "error upload")
            {
                classBulleSpecial = ".upload-error";
            }
            if(errorMsg == "wrong types")
            {
                classBulleSpecial = ".error-type";
            }
            if(errorMsg == "wrong extension")
            {
                classBulleSpecial = ".ext-error"
            }
            if(errorMsg == "too large")
            {
                classBulleSpecial = ".size-error";
            }
            displayErrorBulleSpecial(locationError, classBulleSpecial);
        }

        AJAXloader(false, '#loader-imgs');
    });
}

//delete img function
function deleteTmpImgs(imgName) {
    $.ajax({
        method: 'POST',
        url: "inc/Share/deleteimgtmp.php",
        data: {imgName: imgName}
    })
}

function deleteTmp() {
    $.ajax({
        url: "inc/Share/emptytmp.php"
    })
}

//shared postText
function share(text, imgToPost) {
    //alert(text);
    $.ajax({
        method: 'POST',
        url: "inc/Timeline/post.php",
        data: {texte: text, imgsToPost:JSON.stringify(imgToPost)}
    }).done(function(msg){
        //#todo creer une fonction dans functions.js
        $elem = $('#your-share-container');
        $elem.removeClass('active');
        $(msg).insertAfter("#your-share-container");
        $elem.addClass('active');

        emptyShareBloc();
    });
}

$('#upload-pic').on('change', function(event){
    //bt mask
    $('#share-post').parent().addClass('active-mask');
    //enlève les messages d'erreur precédents
    $('.bulle-error').removeClass('.bulle-error-special');
    //recupère l'imageFile
    files = $(this)[0].files[0];
    //on donne un nom unique a l'image que l'on passe au fom-data
    var imgName = files.name;
    imgName = imgName.replace(/\s|-/g,'');
    //insertion des données ds le formData pour l'envoi
    formData.append(imgName, files);
    //on stocke les noms des images dans un tableau pour le cas de suppression
    imgsToPost.push(imgName);
    AJAXloader(true, '#loader-imgs');
    sharePostImgs(formData, event);
});

//controles sur le bloc texte avant soummission
$('#share-post').click(function () {
    if($shareinput.html() == "")
    {
        displayErrorBulle("#share-input");
        return false;
    }
    else
    {
        share($.trim($shareinput.html()), imgsToPost);
        return false;
    }
});

//delete image from descendant code generated by ading image function
function deletePhoto(e) {
    var pieces = e.attr('id').split('-');
    var imgName = pieces[1];
    e.remove();
    deleteTmpImgs(imgName);
    var removeItem = imgName;
    imgsToPost = $.grep(imgsToPost, function(value) {
        return value != removeItem;
    });
    /*alert(imgsToPost);*/
}

//display error out
$('.img-share-bloc').on('click', '.img-share-input', function(e){
    $(this).removeClass('error-input-special');
    $(this).find('.bulle-error-special').removeClass('bulle-error-special');
});

//afficher le bloc d'agout d'images / videos
var toogleShare = 0;
$('#share-images').click(function(){
    //open
    if(toogleShare == 0)
    {
        $(this).addClass('active');
        $('.img-share-bloc').addClass('active');

        $('#share-videos').fadeOut();
        toogleShare = 1;
        return true;
    }
    //close
    if(toogleShare == 1)
    {
        $(this).removeClass('active');
        $('.img-share-bloc').removeClass('active');
        $('#share-videos').fadeIn();

        if(imgsToPost.length !== 0)
        {
            imgToPost =[];
            deleteTmp();
            $('.img-share-bloc .img-share-container').remove();
        }
        toogleShare = 0;
        return true;
    }
});

//displayErrorOut
$('#share-input').click(function () {
    if($(this).hasClass('error-input')){
        $('div').removeClass('error-input')
    }
});

//resize one photo appercus
$('.post-pic-bloc').each(function(){
    if($(this).find('.post-pic').length == 1)
    {
        resiezOnePhotoBloc($(this));
    }
});

//display images when click on the white shadow division
$('.timeline-container').on('click','.display-next-pic', function(e){
    //recupère la taille d'une des deux div contenat les photos
    var height = $(this).parent().find('.post-pic-container').height();

    //test si l'autre div n'est pas plus grande
    $(this).parent().find('.post-pic-container').each(function(index){
        if($(this).height() > height)
        {
            height = $(this).height();
        }
    });
    //ajout de 5 px pour simuler une marge en bas
    height = height + 10;
    $(this).parents('.post-pic-bloc').css('height',height);
    $(this).addClass('display-next-pic-active');
});